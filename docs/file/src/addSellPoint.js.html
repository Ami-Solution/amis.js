<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/addSellPoint.js | dethergateway</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Gateway between Front App and the detherContracts."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="dethergateway"><meta property="twitter:description" content="Gateway between Front App and the detherContracts."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/dethertech/detherGateway"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dtrRegisterPoint">dtrRegisterPoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-withdrawAll">withdrawAll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dtrGetTellerbalances">dtrGetTellerbalances</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dtrSendCoin">dtrSendCoin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllTsx">getAllTsx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEthBalance">getEthBalance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dtrGetTeller">dtrGetTeller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllTellers">getAllTellers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTellersPerZone">getTellersPerZone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendEther">sendEther</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#constants">constants</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getContractInstance">getContractInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getContractStorageInstance">getContractStorageInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DETHER_CONTRACT">DETHER_CONTRACT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GAS_PRICE">GAS_PRICE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PROVIDER_URL">PROVIDER_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UTILITYWEB3">UTILITYWEB3</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add0x">add0x</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getSignedContract">getSignedContract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getSignedWeb3">getSignedWeb3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decodeKeystore">decodeKeystore</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/addSellPoint.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import decodeKeystore from &apos;./utils/decodeKeystore&apos;;
import { getSignedContract } from &apos;./utils/contractInstance&apos;;
import add0x from &apos;./utils/add0x&apos;;
import { GAS_PRICE, UTILITYWEB3, DETHER_CONTRACT } from &apos;./constants/appConstants&apos;;

// gas used = 223319
// gas price average (mainnet) = 25000000000 wei
// 250000 * 25000000000 = 0.006250000000000000 ETH
// need 0.006250000000000000 ETH to process this function
/**
 * @param {number} lat latitude min -90 max +90
 * @param {number} lng longitude min -180 max +180
 * @param {string} zone geographic zone
 * @param {number} rates Margin (0-100 * 100)
 * @param {number} avatar (1-9)
 * @param {number} currency number (0-4)
 * @param {string} telegam pseudo telegram
 * @param {number} amount escrow
 * @param {string} name username
 * @param {object} keystore deserialize keystore
 * @param {string} password
 * @return {object} Return txs
 */
const dtrRegisterPoint = async (
  lat,
  lng,
  zone,
  rates,
  avatar,
  currency,
  telegram,
  amount,
  name,
  keystore,
  password,
) =&gt;
  new Promise(async (res, rej) =&gt; {
    if (!lat || !lng || !zone || !rates || !avatar || !currency
      || !telegram || !amount || !name || !keystore || !password) {
        return rej(new TypeError(&apos;Invalid arguments&apos;));
      }
    if ((lat &lt; -90 || lat &gt; 90) || (lng &lt; -180 || lng &gt; 180)) {
      return rej(new TypeError(&apos;Invalid lat lng&apos;));
    }
    if (rates &lt; 0 || rates &gt; 10000) return rej(new TypeError(&apos;Invalid rates&apos;));
    if (telegram.length &lt; 3 || telegram.length &gt; 32) return rej(new TypeError(&apos;Invalid telegram&apos;));
    if (amount &lt; 0.0025) return rej(new TypeError(&apos;Invalid amount&apos;));
    if (name.length &lt; 3 || name.lenght &gt; 32) return rej(new TypeError(&apos;Invalid name&apos;));

    const keys = await decodeKeystore(keystore, password);
    const dtrContractInstance = await getSignedContract(keys);

    let tsxAmount = parseInt(UTILITYWEB3.toWei(amount, &apos;ether&apos;), 10);
    const balance = await UTILITYWEB3.eth.getBalance(keys.address);

    if (balance.toNumber() &lt; (tsxAmount + (GAS_PRICE * 650000))) {
      // add if tsxAmount &lt; 0.0025 reject
      tsxAmount = balance.toNumber() - (GAS_PRICE * 650000);
    }

    const result = await dtrContractInstance.registerPoint(
      lat,
      lng,
      zone,
      rates,
      avatar,
      currency,
      telegram,
      name,
      {
        from: add0x(keys.address),
        value: parseInt(tsxAmount, 10),
        gas: 450000,
        GAS_PRICE: 25000000000,
      },
    );
    return res({
        from: add0x(keys.address),
        to: DETHER_CONTRACT.address,
        value: amount,
        date: new Date().toLocaleString(&apos;en-US&apos;, { hour12: false }),
        receive: &apos;no&apos;,
        myEther: &apos;yes&apos;,
        etherscan: `https://kovan.etherscan.io/tx/${result}`,
    });
  });

export default dtrRegisterPoint;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
