<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/tellers/addTellers.js | dethergateway</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Gateway between Front App and the detherContracts."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="dethergateway"><meta property="twitter:description" content="Gateway between Front App and the detherContracts."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/dethertech/detherGateway"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#constants">constants</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getContractInstance">getContractInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getContractStorageInstance">getContractStorageInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getSignedContractInstance">getSignedContractInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GAS_PRICE">GAS_PRICE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PROVIDER_URL">PROVIDER_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UTILITYWEB3">UTILITYWEB3</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#mock">mock</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mock">mock</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mockStorage">mockStorage</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#tellers">tellers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dtrRegisterPoint">dtrRegisterPoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-withdrawAll">withdrawAll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dtrSendCoin">dtrSendCoin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBalance">getBalance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dtrGetTeller">dtrGetTeller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAllTellers">getAllTellers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getTellersPerZone">getTellersPerZone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-tellers">tellers</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/tellers/addTellers.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import ethToolbox from &apos;eth-toolbox&apos;;
import Web3 from &apos;web3&apos;;

import { GAS_PRICE, getSignedContractInstance } from &apos;../constants/appConstants&apos;;

const check = (teller) =&gt; {
  if (!teller.lat || Number.isNaN(teller.lat) || teller.lat &gt; 90 || teller.lat &lt; -90) {
    return { error: true, msg: &apos;Invalid latitude&apos; };
  }
  if (!teller.lng || Number.isNaN(teller.lng) || teller.lng &gt; 180 || teller.lng &lt; -180) {
    return { error: true, msg: &apos;Invalid longitude&apos; };
  }
  if (!teller.zone || !Number.isInteger(teller.zone)) {
    return { error: true, msg: &apos;Invalid zone&apos; };
  }
  if (!teller.rates || teller.rates &lt;= 0 || teller.rates &gt; 100) {
    return { error: true, msg: &apos;Invalid rates&apos; };
  }
  if (!teller.avatar || !Number.isInteger(teller.avatar) || teller.avatar &lt; 0) {
    return { error: true, msg: &apos;Invalid avatar&apos; };
  }
  if (!teller.currency || !Number.isInteger(teller.currency) || teller.currency &lt; 0) {
    return { error: true, msg: &apos;Invalid currency&apos; };
  }
  if (!teller.telegram || teller.telegram.length &lt; 3 || teller.telegram.length &gt; 30) {
    return { error: true, msg: &apos;Invalid telegram&apos; };
  }
  if (!teller.amount || Number.isNaN(teller.amount) || teller.amount &lt; 0.01) {
    return { error: true, msg: &apos;Invalid amount&apos; };
  }
  if (!teller.username || teller.username.length &lt; 3 || teller.username.length &gt; 30) {
    return { error: true, msg: &apos;Invalid username&apos; };
  }
  if (!teller.keystore) {
    return { error: true, msg: &apos;Invalid keystore&apos; };
  }
  if (!teller.password || teller.password.length &lt; 1) {
    return { error: true, msg: &apos;Invalid password&apos; };
  }
  if (!teller.providerUrl) {
    return { error: true, msg: &apos;Invalid provider url&apos; };
  }
  // if (!teller.gasPrice || teller.gasPrice &lt; 0) {
  //   return { error: true, msg: &apos;Invalid gas Price&apos; };
  // }
  return {};
};

// gas used = 223319
// gas price average (mainnet) = 25000000000 wei
// 250000 * 25000000000 = 0.006250000000000000 ETH
// need 0.006250000000000000 ETH to process this function
/**
 * @param {number} lat latitude min -90 max +90
 * @param {number} lng longitude min -180 max +180
 * @param {string} zone geographic zone
 * @param {number} rates Margin (0-100 * 100)
 * @param {number} avatar (1-9)
 * @param {number} currency number (0-4)
 * @param {string} telegam pseudo telegram
 * @param {number} amount escrow
 * @param {string} username username
 * @param {object} keystore deserialize keystore
 * @param {string} password
 * @param {string} providerUrl
 * @return {object} Return txs
 */
const dtrRegisterPoint = async (teller) =&gt;
  new Promise(async (res, rej) =&gt; {
    const secu = check(teller);
    if (secu.error) return rej(new TypeError(secu.msg));

    try {
      const key = await ethToolbox.decodeKeystore(teller.keystore, teller.password);
      if (!key || !key.privateKey || !key.address || !ethToolbox.utils.isAddr(key.address)) {
        return rej(new TypeError(&apos;Invalid keystore or password&apos;));
      }

      const dtrContractInstance =
        await getSignedContractInstance(key.privateKey, key.address, teller.providerUrl);

      const utilityWeb3 = new Web3(new Web3.providers.HttpProvider(teller.providerUrl));

      let tsxAmount = parseInt(utilityWeb3.toWei(teller.amount, &apos;ether&apos;), 10);

      if (teller.providerUrl !== &apos;test&apos;) {
        const balance = await utilityWeb3.eth.getBalance(key.address);
         // check if enough gas is present to sendCoin once after registering
         if (balance.toNumber() &lt; (tsxAmount + (GAS_PRICE * 650000))) {
           tsxAmount = balance.toNumber() - (GAS_PRICE * 650000);
           if (tsxAmount &lt; 0.0025) return rej(new TypeError(&apos;Insufficient funds&apos;));
         }
      }
      const result = await dtrContractInstance.registerPoint(
        teller.lat.toFixed(6) * (10 ** 5),
        teller.lng.toFixed(6) * (10 ** 5),
        teller.zone,
        teller.rates * 100,
        teller.avatar,
        teller.currency,
        teller.telegram,
        teller.username,
        {
          from: ethToolbox.utils.add0x(key.address),
          value: parseInt(tsxAmount, 10),
          gas: 450000,
          gasPrice: GAS_PRICE,
        },
      );
      return res({
          from: ethToolbox.utils.add0x(key.address),
          to: dtrContractInstance.address,
          value: teller.amount,
          date: new Date().toLocaleString(&apos;en-US&apos;, { hour12: false }),
          dether: {
            detherContract: true,
            receive: false,
          },
          etherscan: {
            kovan: `https://kovan.etherscan.io/tx/${result}`,
            ropsten: `https://ropsten.etherscan.io/tx/${result}`,
            ether: `https://etherscan.io/tx/${result}`,
          },
      });
    } catch (e) {
      return rej(new TypeError(e));
    }
  });

export default dtrRegisterPoint;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.3)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
